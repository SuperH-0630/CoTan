<!DOCTYPE html>
<html lang="zh">
    <head>
        <link rel="stylesheet" type="text/css" href="Communication.css">
        <meta charset="UTF-8">
        <title>Hello</title>
    </head>
    <body>
        <script>
            let host = 'http://127.0.0.1:5000/'
        </script>
        <canvas id="canvas" class="bg_canvas"></canvas>
        <div class="screen" id="screen">
            <div class="nothing"></div>
            <div class="form" id="form">
                <div>
                    <label for="sentfunc" class="font" id="sentfunc_labe">选定发送方式:</label>
                    <select id="sentfunc" class="font">
                        <option value="done ">执行python</option>
                        <option value="get_var ">获取变量</option>
                        <option value="get var_* ">获取所有变量</option>
                        <option value="get * ">获取通信变量</option>
                        <option value="get_eval ">返回代码</option>
                        <option value="put_var ">发送变量</option>
                        <option value="put_eval ">发送代码</option>
                        <option value="file ">发送文件</option>
                    </select>
                    <input type="file" id="get_file" style="display:none;"/>
                    <label for="message" class="font">输入发送对象:</label>
                    <input id="message" class="font text" type="text">
                    <button class="font button" onclick="sent()">发送消息</button>
                    <button class="font button" onclick="document.getElementById('get_file').click()">选择文件</button>
                    <script>
                            let the_file = document.getElementById("get_file");
                            the_file.addEventListener("change",function () {
                            let message_input = document.getElementById("message");
                            message_input.value = message_input.value + the_file.value;
                        });
                    </script>
                </div>
                <div class="nothing"></div>
                <div>
                    <label for="prosser_list"></label>
                    <select id="prosser_list" class="font box" size=30>
                    </select>
                    <label for="var_list"></label>
                    <select id="var_list" class="font box" size=30>
                    </select>
                </div>
            </div>
        </div>
        <script>
            function sent() {
                let sentbox = document.getElementById("sentfunc");
                let the_prosser_list = document.getElementById("prosser_list");
                let first = sentbox.options[sentbox.selectedIndex].value;
                let index = String(the_prosser_list.options[the_prosser_list.selectedIndex].value);
                let message = first + document.getElementById("message").value;
                let xhr = new XMLHttpRequest();
                xhr.onloadend = function () {
                    };
                xhr.open('get', host + "sent?message=" + message + '&index=' + index, true);
                xhr.send();
                }
            function update(is_must) {
                console.log('1');
                function get_update(is_must){
                        let xhr = new XMLHttpRequest();
                        xhr.onloadend = function () {
                            if (xhr.status === 200) {
                                let json = JSON.parse(xhr.responseText);
                                console.log(json['status']);
                                if (json['status'] === 'YES'){
                                    let p_box = document.getElementById("prosser_list");
                                    let var_box = document.getElementById("var_list");
                                    p_box.innerHTML='';
                                    var_box.innerHTML='';
                                    for (i of json['queue']){
                                        let y=document.createElement('option');
                                        y.text=String(i);
                                        y.value=String(i);
                                        p_box.add(y, null)
                                    }
                                    for (i of json['var']){
                                        let y=document.createElement('option');
                                        y.text=String(i);
                                        y.value=String(i);
                                        var_box.add(y, null)
                                    }
                                    console.log(json['queue']);
                                    console.log(json['var']);
                                }
                            }};
                        let must = '?must=' + is_must;
                        xhr.open('get',host + "update" + must,true);
                        console.log(must);
                        xhr.send();
                    }
                get_update(is_must)
            }
            update('must');
            let t_update = window.setInterval("update('No')",1000);

            class Circle {
                    constructor(x, y) {
                        this.x = x;
                        this.y = y;
                        this.r = Math.random() * 10 ;
                        this._mr = Math.random();
                        this._mx = (Math.random() - 0.5) * 2;
                        this._my = (Math.random() - 0.5) * 2 ;
                        this.ax = 0;
                        this.ay = 0;

                    }

                    drawCircle(ctx) {
                        ctx.beginPath();  // 开始绘制
                        ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI);  // 画弧线
                        ctx.closePath();  // 结束绘制
                        ctx.fillStyle = 'rgba(204, 204, 204, 0.3)';
                        ctx.fill();
                    }

                    drawLine(ctx, _circle) {
                        let dx = this.x - _circle.x;  // 差距
                        let dy = this.y - _circle.y;  // 差距
                        let d = Math.sqrt(dx * dx + dy * dy);  // 勾股距离
                        if (d < 180) {
                            ctx.beginPath();
                            //开始一条路径，移动到位置 this.x,this.y。创建到达位置 _circle.x,_circle.y 的一条线：
                            ctx.moveTo(this.x, this.y);   //起始点
                            ctx.lineTo(_circle.x, _circle.y);   //终点
                            ctx.closePath();
                            ctx.strokeStyle = 'rgba(204, 204, 204, ' + String(1 - (d/180)) + ')';
                            ctx.stroke();
                        }
                    }

                    set_a(ax, ay){
                        this.ax += ax;
                        this.ax /= 2;
                        this.ay += ay;
                        this.ay /= 2;
                    }

                    set_a_first(){
                        if (Math.abs(this._mx) > 3) {
                            this.ax = 0;
                            this._mx = (Math.random() - 0.5) * 2;
                        }
                        if (Math.abs(this._my) > 3) {
                            this.ay = 0;
                            this._my = (Math.random() - 0.5) * 2;
                        }
                    }

                        // 圆圈移动
                        // 圆圈移动的距离必须在屏幕范围内
                    move(w, h) {
                        this._mx += this.ax;
                        this._my += this.ay;

                        this._mx = (this.x < w && this.x > 1) ? this._mx : (-this._mx);
                        this._my = (this.y < h && this.y > 1) ? this._my : (-this._my);
                        this._mr = (this.r < 10 && this.r > 1) ? this._mr : (-this._mr);
                        this.x += this._mx / 2;
                        this.y += this._my / 2;
                        this.r += this._mr / 2;
                        if (this.r <= 0){
                            this._mr = -this._mr;
                            this.r = -this.r;
                        }
                        }}
            //鼠标点画圆闪烁变动
                class currentCirle extends Circle {
                    constructor(x, y) {
                        super(x, y);
                        this.r = 8;
                        this.R = 30;
                        this.rad = 0;
                        this.circle = ['rgba(204, 204, 204,0.9)'];
                    }

                    drawLine(ctx, _circle) {
                        let dx = this.x - _circle.x;  // 差距
                        let dy = this.y - _circle.y;  // 差距
                        let d = Math.sqrt(dx * dx + dy * dy);  // 勾股距离
                        if (d < 180){
                            ctx.beginPath();
                            ctx.moveTo(this.x, this.y);   //起始点
                            ctx.lineTo(_circle.x, _circle.y);   //终点
                            ctx.closePath();
                            ctx.strokeStyle = 'rgba(204, 0, 0, ' + String(1 - (d / 180)) + ')';
                            ctx.stroke();
                            _circle.set_a(dx / 1800, dy / 1800);
                        }else{
                            _circle.set_a_first()
                        }
                    }

                    drawCircle(ctx) {
                        let l = this.circle.length;
                        for (let i of this.circle){
                            let dx = this.R * Math.cos(this.rad);
                            let dy = this.R * Math.sin(this.rad);
                            ctx.beginPath();  // 开始绘制
                            ctx.arc(this.x + dx, this.y + dy, this.r, 0, 2 * Math.PI);  // 画弧线
                            ctx.closePath();  // 结束绘制
                            ctx.fillStyle = i;
                            ctx.fill();
                            this.rad += 2 * Math.PI * (1 / l);
                            if (this.rad >= 2 * Math.PI){
                                this.rad -= 2 * Math.PI}
                        }
                        this.rad += Math.PI * (15 / 180);
                    }
                }
                //更新页面用requestAnimationFrame替代setTimeout
                window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;

                let canvas = document.getElementById('canvas');
                let ctx = canvas.getContext('2d');
                let w = canvas.width = canvas.offsetWidth;
                let h = canvas.height = canvas.offsetHeight;
                let circles = [];
                let current_circle = new currentCirle(0, 0);  // 鼠标位置
                let update_times = 0;
                let draw = function () {
                    ctx.clearRect(0, 0, w, h);  // 清空
                    for (let i = 0; i < circles.length; i++) {
                        circles[i].move(w, h);
                        circles[i].drawCircle(ctx);
                        for (j = i + 1; j < circles.length; j++) {
                            circles[i].drawLine(ctx, circles[j])
                        }
                    }
                    if (current_circle.x) {
                        current_circle.drawCircle(ctx);
                        for (let k = 1; k < circles.length; k++) {
                            current_circle.drawLine(ctx, circles[k])
                        }
                    }else{
                        for (let k = 1; k < circles.length; k++) {
                            current_circle.set_a_first()
                        }
                    }
                    update_times += 1;
                    if (update_times >= 100) {
                        circles.push(new Circle(Math.random() * w, Math.random() * h));
                        circles.shift();
                        update_times = 0
                    }
                    requestAnimationFrame(draw)
                };

                let init = function (num) {
                    for (var i = 0; i < num; i++) {
                        circles.push(new Circle(Math.random() * w, Math.random() * h));
                    }
                    draw();
                };
                window.addEventListener('load', init(220));
                window.onmousemove = function (e) {  // 鼠标进入范围
                    // e = e || window.event;
                    current_circle.x = e.clientX;
                    current_circle.y = e.clientY;
                };
                window.onmouseout = function () {  // 鼠标移出反围
                    current_circle.x = null;
                    current_circle.y = null;

                };
        </script>
    </body>
</html>